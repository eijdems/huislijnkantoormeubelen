<?php 
$helper = $this->helper('Emizen\Customsearch\Helper\Data');
$checkLogin = $helper->getCustomLogin(); 
?>

<?php if ($checkLogin) : ?>
    <?php
        $product = $block->getProduct();
        $pId = $product['entity_id'];
        $_helper = $this->helper('FME\Productattachments\Helper\Data'); 
        $attachmentData = $_helper->getProductAttachmentsById($pId);
        $parentCategoryId = 5; // Set your main category ID here

        /**
         * Recursive function to get child categories and display attachments
         */
        function renderCategoryAttachments($helper, $attachments, $categoryId, $level = 1, $maxLevel = 4) {
            if ($level > $maxLevel) {
                return;
            }

            $childCategories = $helper->getSubCategories($categoryId);
            if ($childCategories && $childCategories->count()) {
                foreach ($childCategories as $childCategory) {
                    $childCategoryId = $childCategory->getId(); 
                    $childCategoryName = $childCategory->getCategoryName(); // Or ->getName()

                    // Filter attachments for this child category
                    $filteredAttachments = array_filter($attachments, function($attachment) use ($childCategoryId) {
                        return $attachment['cat_id'] == $childCategoryId;
                    });

                    if (!empty($filteredAttachments)) {
                        echo '<h3 class="fme_image">' . htmlspecialchars($childCategoryName) . '</h3>';
                        echo '<div class="attachments-container">';
                        foreach ($filteredAttachments as $attachment) {
                            $title = htmlspecialchars($attachment['title'] ?? 'No title');
                            $link = $attachment['download_link'] ?? '#';
                            echo '<div class="img-attachment">';
                            echo '<a href="' . $link . '" download data-title="' . $title . '">';
                            echo '<img src="' . $link . '" alt="' . $title . '" style="max-width:150px;">';
                            echo '</a></div>';
                        }
                        echo '</div>';
                    }

                    // Recursive call for next level
                    renderCategoryAttachments($helper, $attachments, $childCategoryId, $level + 1, $maxLevel);
                }
            }
        }

        // Start from parent category
        renderCategoryAttachments($_helper, $attachmentData, $parentCategoryId);
    ?>
<?php endif; ?>

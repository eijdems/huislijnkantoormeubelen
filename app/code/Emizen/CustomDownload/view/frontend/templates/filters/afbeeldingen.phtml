<?php
$_helper = $this->helper('FME\Productattachments\Helper\Data');
$categoryId = 5; // Main category ID

$subCategoryIds = [];
$categoryNames = [];

/**
 * Recursively fetch subcategories and map ID to name
 */
function getSubCategoriesRecursive($categoryId, &$categoryNames, &$subCategoryIds, $_helper) {
    $subCategories = $_helper->getSubCategories($categoryId);

    foreach ($subCategories as $subCat) {
        $id = $subCat->getCategoryId();
        $name = $subCat->getCategoryName();

        $subCategoryIds[] = $id;
        $categoryNames[$id] = $name;

        getSubCategoriesRecursive($id, $categoryNames, $subCategoryIds, $_helper);
    }
}

// Get all subcategories
getSubCategoriesRecursive($categoryId, $categoryNames, $subCategoryIds, $_helper);

$attachmentsByCategory = [];

if (!empty($subCategoryIds)) {
    $allAttachments = $_helper->getProductAttachments();
    $allAttachments->addFieldToFilter('main_table.cat_id', ['in' => $subCategoryIds]);

    foreach ($allAttachments as $attachment) {
        $catId = $attachment->getCatId();
        $attachmentsByCategory[$catId][] = $attachment;
    }
}
?>
<h2>Downloads</h2>
<br>
<?php if (!empty($attachmentsByCategory)): ?>
    <?php foreach ($attachmentsByCategory as $catId => $attachments): ?>
        <div class="subcategory-heading ">
            <h2><?= htmlspecialchars($categoryNames[$catId] ?? 'No name available'); ?></h2>

            <div class="attachments">
                <?php foreach ($attachments as $attachment): ?>

                    <div class="img-attachment">
                        <a href="<?= $attachment->getDownloadLink(); ?>"
                           download
                           title="<?= htmlspecialchars($attachment->getTitle() ?? 'No title available'); ?>">
                            <img src="<?= $attachment->getDownloadLink(); ?>"
                                 alt="<?= htmlspecialchars($attachment->getTitle() ?? 'No title available'); ?>" 
                                 style="max-width:150px;">
                        </a>
                    </div>

                <?php endforeach; ?>
            </div>
        </div>
    <?php endforeach; ?>
<?php else: ?>
    <p>No images available for subcategories.</p>
<?php endif; ?>
